<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<title>Exemplo Select Dinâmico com Funções Assíncronas</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-5">

	<div class="container">
		<h3 class="mb-4">Seletores Dinâmicos</h3>

		<div class="row">
			<!-- Primeiro select -->
			<div class="col-md-6 mb-3">
				<label for="select1" class="form-label">Selecione uma categoria</label>
				<select id="select1" class="form-select" onchange="atualizarOpcoes()">
					<option value="">-- Escolha --</option>
					<option value="1">Frutas</option>
					<option value="2">Carros</option>
				</select>
			</div>

			<!-- Segundo select -->
			<div class="col-md-6 mb-3">
				<label for="select2" class="form-label">Opções disponíveis</label>
				<select id="select2" class="form-select">
					<option value="">-- Escolha uma categoria primeiro --</option>
				</select>
			</div>
		</div>
	</div>

	<script>
		// Função principal chamada no onchange
		async function atualizarOpcoes() {
			const categoria_id = document.getElementById('select1').value;
			const select2 = document.getElementById('select2');

			limparSelect(select2);

			if (categoria_id === '') {
				preencherSelect(select2, [{ value: '', label: '-- Escolha uma categoria primeiro --' }]);

				return;
			}

			preencherSelect(select2, [{ value: '', label: 'Carregando...' }]);

			try {
				const dados = await buscarDados(categoria_id);

				if (dados.length > 0) 
					preencherSelect(select2, dados);
				else 
					preencherSelect(select2, [{ value: '', label: 'Nenhum resultado encontrado' }]);
				
			} catch (erro) {
				preencherSelect(select2, [{ value: '', label: 'Erro ao carregar dados' }]);
			}
		}

		// Função que faz a chamada assíncrona à API
		async function buscarDados(id) {
			//Se for via GET
			//const resposta = await fetch(`/api/busca_opcoes.php?categoria_id=${id}`);

			//Se for via POST
			const resposta = await fetch('/api/busca_opcoes.php', {
         	method: 'POST',
         	headers: {
            	'Content-Type': 'application/x-www-form-urlencoded'
          	},
          	body: new URLSearchParams({ categoria_id: id })
        	});

			if (!resposta.ok) 
				throw new Error('Erro na requisição');
			
			return await resposta.json();
		}

		// Função que limpa o select
		function limparSelect(select) {
			select.innerHTML = '';
		}

		// Função que preenche o select com dados
		function preencherSelect(select, opcoes) {
			limparSelect(select);

			opcoes.forEach(item => {
				const option = document.createElement('option');

				option.value = item.value;
				option.textContent = item.label;

				select.appendChild(option);
			});
		}
	</script>
</body>
</html>